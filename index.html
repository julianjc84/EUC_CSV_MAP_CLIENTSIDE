<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EUC Ride Data Viewer - Client Side</title>

    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%230d6efd'/%3E%3Crect x='6' y='20' width='4' height='8' fill='white'/%3E%3Crect x='12' y='14' width='4' height='14' fill='white'/%3E%3Crect x='18' y='8' width='4' height='20' fill='white'/%3E%3Crect x='24' y='12' width='4' height='16' fill='white'/%3E%3C/svg%3E">

    <!-- Leaflet CSS (Local) -->
    <link rel="stylesheet" href="vendor/leaflet/leaflet.css" />

    <!-- Bootstrap CSS (Local) -->
    <link href="vendor/css/bootstrap.min.css" rel="stylesheet">

    <!-- noUiSlider CSS (CDN) - For dual-handle range slider -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <script>history.scrollRestoration = 'manual'; window.scrollTo(0, 0);</script>
    <!-- Header -->
    <nav class="navbar py-2 site-navbar">
        <div class="container-fluid">
            <div class="d-flex align-items-center flex-wrap gap-2 w-100">
                <span class="navbar-brand mb-0 h1 me-auto">EUC CSV DASHBOARD</span>
                <button class="btn btn-sm map-style-btn" id="back-to-files-btn" style="display: none;" onclick="window.backToFileList()">
                    ‚Üê Back to Files
                </button>
                <span class="small" id="file-info">No file loaded</span>
                <div class="form-check form-switch mb-0 me-2" title="Toggle dark/light color scheme">
                    <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle">
                    <label class="form-check-label small" for="dark-mode-toggle">Dark</label>
                </div>
                <button class="btn btn-sm map-style-btn" onclick="document.getElementById('csv-file-input').click()">
                    Choose CSV File
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid mt-3" id="main-container">
        <!-- Hidden file input -->
        <input type="file" id="csv-file-input" accept=".csv" style="display: none;">

        <!-- Data View Section (always visible) -->
        <div id="data-view">
            <!-- Overview Card -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-overview"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>üìã Overview Stats
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-overview">
                            <div class="card-body">
                                <div class="row" id="overview-stats">
                                    <!-- Stats will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Card -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-controls"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>‚öôÔ∏è Controls
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-controls">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="form-check form-switch" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>PWM Mode Control</strong><br><br><strong>Auto-Detection (on file load):</strong><br>‚Ä¢ Analyzes first 10 values to detect mode<br>‚Ä¢ Mode 1: 0-100% (avg &lt; 50) ‚Üí skull at 100%<br>‚Ä¢ Mode 2: 100-0% (avg ‚â• 50) ‚Üí skull at 0%<br>‚Ä¢ Raw data displayed by default<br><br><strong>Manual Flip (toggle this switch):</strong><br>‚Ä¢ OFF: Show raw data as-is<br>‚Ä¢ ON: Invert values (100 - value)<br>&nbsp;&nbsp;- Mode 1 ‚Üí Mode 2<br>&nbsp;&nbsp;- Mode 2 ‚Üí Mode 1<br><br><strong>Typical Files:</strong><br>‚Ä¢ EUC World: Mode 2 (100-0%)<br>‚Ä¢ WheelLog/DarknessBot: Mode 1 (0-100%)">
                                        <input class="form-check-input" type="checkbox" role="switch" id="pwm-flip-toggle">
                                        <label class="form-check-label" for="pwm-flip-toggle">
                                            <strong>Flip PWM</strong>
                                            <div id="pwm-mode-status" class="small text-muted" style="margin-top: 2px; font-weight: normal;">
                                                <!-- Auto-detected mode status will appear here -->
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-auto" id="diagnostic-toggle-container">
                                    <div class="form-check form-switch" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Diagnostic View</strong><br><br>Shows every CSV column in the loaded file:<br>‚Ä¢ Which columns are mapped to charts/data<br>‚Ä¢ Which columns are <strong>unmapped</strong> (unknown)<br>‚Ä¢ Sample values from each column<br><br>Useful for discovering new data fields in CSV files.">
                                        <input class="form-check-input" type="checkbox" role="switch" id="diagnostic-view-toggle">
                                        <label class="form-check-label" for="diagnostic-view-toggle">
                                            <strong>Diagnostic View</strong>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-auto" id="hue-controls-container" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Theme Hue</strong><br><br>Shift the accent color hue (0-360¬∞) across the entire UI:<br>‚Ä¢ Buttons, links, and highlights<br>‚Ä¢ Footer accent and links<br>‚Ä¢ Chart axis lines, labels, and grid<br>‚Ä¢ Tooltips and code text<br><br>Colors adapt to light/dark mode automatically.<br><br>üé≤ = Random hue&nbsp;&nbsp;&nbsp;‚Ü∫ = Reset to default">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="hue-swatch" id="hue-swatch"></span>
                                        <label class="small mb-0 hue-label" for="hue-slider">Theme Hue</label>
                                        <input type="range" id="hue-slider" min="0" max="360" step="1" class="hue-slider">
                                        <span class="small mb-0 hue-value" id="hue-value">‚Äî</span>
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" id="hue-random-btn" title="Random hue">üé≤</button>
                                        <button class="btn btn-sm btn-outline-secondary py-0 px-1" id="hue-reset-btn" title="Reset to default">‚Ü∫</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CSV Column Diagnostics -->
            <div class="row mb-3" id="diagnostic-card" style="display: none;">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-diagnostics"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>üî¨ CSV Column Diagnostics
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-diagnostics">
                            <div class="card-body">
                                <div id="diagnostic-summary" class="mb-3"></div>
                                <div id="diagnostic-table-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Render Statistics -->
            <div class="row mb-3" id="render-stats-section">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-render-stats"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>üìä Render Statistics
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-render-stats">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Source Document</strong><br><br>Total number of rows (data points) in the original CSV file.<br>Each row is typically 1 sample per second recorded by the wheel.<br><br><strong>Example:</strong> A 30-minute ride at 1 sample/sec = ~1,800 points.">
                                        <small class="text-muted d-block">Source Document</small>
                                        <span class="badge bg-secondary" id="stat-source-points">0 points</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Currently Displayed</strong><br><br>Number of data points currently being displayed.<br><br>This equals Source Document unless you have:<br>‚Ä¢ Applied a Time Range Trim (reduces points)<br>‚Ä¢ Enabled Privacy Mode (hides start/end points)<br><br>Lower than source = data has been filtered.">
                                        <small class="text-muted d-block">Currently Displayed</small>
                                        <span class="badge bg-secondary" id="stat-displayed-points">0 points</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Leaflet Map Segments</strong><br><br>Number of colored polyline segments drawn on the Leaflet map.<br><br>The GPS route is split into chunks of data points.<br>Each chunk becomes one colored line on the map.<br>The color represents the <strong>AVERAGE</strong> value (speed, PWM, etc.) of all points within that chunk.<br><br>More segments = smoother color transitions but more rendering work.">
                                        <small class="text-muted d-block">Leaflet Map Segments</small>
                                        <span class="badge bg-secondary" id="stat-map-segments">0 segments</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" data-bs-title="<strong>Chart Render Points</strong><br><br>Number of data points actually rendered in the charts.<br><br>If this is less than Currently Displayed, the charts are downsampling (skipping points) for performance.<br><br>Charts cap at 5,000 render points. Above that, every Nth point is drawn to stay within the limit.">
                                        <small class="text-muted d-block">Chart Render Points</small>
                                        <span class="badge bg-secondary" id="stat-chart-points">0 points</span>
                                    </div>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Points per Map Segment</strong><br><br><strong>Formula:</strong> Displayed Points √∑ Map Segments<br><br>All points in the chunk are averaged to produce <strong>ONE</strong> color.<br>Higher numbers = more data averaged per segment = less detail.<br><br><strong>Example:</strong> 50 pts/seg means 50 speed readings are averaged into a single color on the map. A brief speed spike could be hidden by the surrounding slower values.">
                                        <small class="text-muted d-block">Points per Map Segment</small>
                                        <span class="badge bg-secondary" id="stat-points-per-segment">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Seconds per Segment</strong><br><br><strong>Formula:</strong> Total Ride Duration √∑ Map Segments<br><br>This tells you the time window being averaged into one color.<br><br><strong>Example:</strong> 12.5s/seg means each colored line on the map represents 12.5 seconds of riding averaged together. A 3-second burst to high speed within that window would be smoothed out.">
                                        <small class="text-muted d-block">Seconds per Segment</small>
                                        <span class="badge bg-secondary" id="stat-seconds-per-segment">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Chart Downsample</strong><br><br><strong>1:1 (all points)</strong> = every data point is drawn in the charts.<br><strong>every Nth point</strong> = charts skip points to stay under 5,000.<br><br><strong>Example:</strong> 'every 2nd point' means half the data points are skipped. The chart still looks smooth but fine-grained spikes may be missed between drawn points.">
                                        <small class="text-muted d-block">Chart Downsample</small>
                                        <span class="badge bg-secondary" id="stat-chart-downsample">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Sample Rate</strong><br><br><strong>Formula:</strong> Displayed Points √∑ Total Ride Duration<br><br>How frequently the logging app recorded data points.<br>This is the link between Points per Segment and Seconds per Segment.<br><br>Higher sample rates = more data points per second = larger files but finer detail.">
                                        <small class="text-muted d-block">Sample Rate</small>
                                        <span class="badge bg-secondary" id="stat-sample-rate">‚Äî</span>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>File Size</strong><br><br>Size of the CSV file on disk.<br><br>Larger files contain more data points and take longer to parse and render.">
                                        <small class="text-muted d-block">File Size</small>
                                        <span class="badge bg-secondary" id="stat-file-size">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Render Time</strong><br><br>Total time to parse the CSV and render all visualizations (map, charts, stats).<br><br>Affected by file size, number of data points, and browser performance.">
                                        <small class="text-muted d-block">Render Time</small>
                                        <span class="badge bg-secondary" id="stat-render-time">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>GPS Points</strong><br><br>Number of data points with valid GPS coordinates (latitude and longitude).<br><br>Some CSV rows may lack GPS data (no satellite lock, indoor logging, etc.).<br>If lower than Source Document, parts of the ride have no map coverage.">
                                        <small class="text-muted d-block">GPS Points</small>
                                        <span class="badge bg-secondary" id="stat-gps-points">‚Äî</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-2" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" data-bs-title="<strong>Charts Rendered</strong><br><br>Number of chart canvases drawn for this file.<br><br>Varies by CSV format ‚Äî EUC World files typically have more data columns and produce more charts than WheelLog or DarknessBot files.">
                                        <small class="text-muted d-block">Charts Rendered</small>
                                        <span class="badge bg-secondary" id="stat-charts-rendered">‚Äî</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GPS Map -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-gps-map"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>üó∫Ô∏è GPS Map
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-gps-map">
                            <div class="card-body p-0">
                                <div id="gps-map" style="height: 800px; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-charts"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>üìà Charts
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-charts">
                            <div class="card-body">
                                <div id="charts-container">
                                    <!-- Charts will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Time Range Trimmer -->
            <div class="row mb-3" id="time-range-section">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header card-collapse-toggle"
                             data-bs-toggle="collapse" data-bs-target="#collapse-time-range"
                             role="button" aria-expanded="true">
                            <h6 class="mb-0">
                                <span class="collapse-arrow"></span>‚è±Ô∏è Time Range Trimmer
                                <span class="collapse-hint">(tap to expand)</span>
                            </h6>
                        </div>
                        <div class="collapse show" id="collapse-time-range">
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col">
                                        <small class="text-muted" id="time-start-label">00:00:00</small>
                                    </div>
                                    <div class="col text-center">
                                        <span class="badge bg-secondary" id="time-duration-badge">Full Ride</span>
                                    </div>
                                    <div class="col text-end">
                                        <small class="text-muted" id="time-end-label">00:00:00</small>
                                    </div>
                                </div>
                                <!-- Dual-handle range slider (noUiSlider) -->
                                <div id="time-range-slider" class="mb-3"></div>
                                <div class="row mt-5 align-items-center">
                                    <div class="col-auto">
                                        <button class="btn map-style-btn" id="reset-time-btn">Reset Trim</button>
                                    </div>
                                    <div class="col"></div>
                                    <div class="col-auto">
                                        <button class="btn map-style-btn" id="apply-time-btn" disabled>Apply Trim</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 text-white">Processing CSV file...</div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="container-fluid">
            <div class="footer-content">
                <div class="footer-left">
                    <span id="footer-datetime">Loading...</span>
                </div>
                <div class="footer-center">
                    <div style="margin-bottom: 4px;">üìé Built with Data Privacy in mind</div>
                    <div>Generated by <a href="https://github.com/julianjc84/EUC_CSV_MAP_CLIENTSIDE" target="_blank" rel="noopener noreferrer">EUC CSV Map</a></div>
                    <div style="margin-top: 4px;"><a href="https://t.me/julianjc84" target="_blank" rel="noopener noreferrer">Contact me on Telegram</a></div>
                </div>
                <div class="footer-right">
                    <span class="version-badge" style="margin-right: 8px;">v1.0.5</span>
                    <a href="https://github.com/julianjc84/EUC_CSV_MAP_CLIENTSIDE" target="_blank" rel="noopener noreferrer" title="View on GitHub">
                        <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- External Libraries (Local) -->
    <!-- Papa Parse for CSV parsing -->
    <script src="vendor/js/papaparse.min.js"></script>

    <!-- Leaflet for maps -->
    <script src="vendor/leaflet/leaflet.js"></script>

    <!-- Bootstrap JS -->
    <script src="vendor/js/bootstrap.bundle.min.js"></script>

    <!-- noUiSlider JS (CDN) - For dual-handle range slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <!-- Chart Synchronization System (must load first) -->
    <script src="js/00-init.js"></script>

    <!-- GPS Map Overlay Configuration (must load before GPS map module) -->
    <script src="js/01-overlay-config.js"></script>

    <!-- Canvas Chart Library (Non-module) -->
    <script src="js/charts/canvas-chart.js"></script>

    <!-- GPS Map Module (loaded for advanced features, but optional) -->
    <script type="module" src="js/map/gps-map-main.mjs"></script>

    <!-- Application Modules -->
    <script type="module" src="js/processors/format-detector.js"></script>
    <script type="module" src="js/processors/eucworld-processor.js"></script>
    <script type="module" src="js/processors/wheellog-processor.js"></script>
    <script type="module" src="js/processors/darknessbot-processor.js"></script>
    <script type="module" src="js/app.js"></script>
</body>
</html>
